{% extends "base.html" %}
{% block content %}

<div class="jumbotron">
    <div class="container">
    <h1>Safe Eats</h1>
    <p>This is a Django App that showcases the Restaurant Health Inspection Reports for King County (City of Seattle) Restaurants.</br></br>
        Click on a marker to view to a short health inspection response.</br>
        Click on the restaurant name to view a history of reports.</p>
    </div>
</div>
<div class="container mainContent">
    <div id="map"></div>
</div>

<script src="http://maps.google.com/maps/api/js?sensor=false"
        type="text/javascript"></script>
<script>
    var infos = [];
    var loc = {{ restaurants|safe }};

    function initialize() {

        var myOptions = {
            center: new google.maps.LatLng(47.608013, -122.335167),
            zoom: 10,
            mapTypeId: google.maps.MapTypeId.ROADMAP

        };
        var map = new google.maps.Map(document.getElementById("map"),
                myOptions);

        setMarkers(map, loc)

    }


    function setMarkers(map, loc) {

        for (var i in loc) {
            var obj = loc[i];
            var name = obj.name;
            var lat = obj.latitude;
            var long = obj.longitude;

            latlngset = new google.maps.LatLng(lat, long);

            var marker = new google.maps.Marker({
                map: map, title: name, position: latlngset
            });
            map.setCenter(marker.getPosition());

            var content = '<div><b><a href="restaurants/' + obj.bus_id + '/">' + obj.name + '</a></b></div>' + '<div>' + obj.address + '</div>' + '<div>' + 'Inspection Result:  ' + obj.results.result_1.inspection_result + '</div>' + '<div>' + obj.results.result_1.description + '</div>';

            var infowindow = new google.maps.InfoWindow();

            google.maps.event.addListener(marker, 'click', (function (marker, content, infowindow) {
                return function () {
                    /* close the previous info-window */
                    closeInfos();
                    infowindow.setContent(content);
                    infowindow.open(map, marker);
                    /* keep the handle, in order to close it on next click event */
                    infos[0] = infowindow;
                };
            })(marker, content, infowindow));
        }
    }

    function closeInfos() {
        if (infos.length > 0) {
            /* detach the info-window from the marker ... undocumented in the API docs */
            infos[0].set("marker", null);
            /* and close it */
            infos[0].close();
            /* blank the array */
            infos.length = 0;
        }
    }
    initialize();
</script>

{% endblock %}